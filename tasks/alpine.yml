version: '3'

tasks:
  ssh_agent:
    desc: "Sets up SSH agent"
    summary: |
      Installs and sets up SSH agent given a private key. Also populates the
      known hosts file.

      usage: task alpine:ssh_agent ssh_private_key="-----BEGIN OPENSSH PRIVATE KEY-----\n..." ssh_known_hosts="[codeserver.dev.1234.drush.in]:2222 ssh-rsa ..."

      ssh_private_key         The SSH private key contents generated by ssh-keygen
      ssh_known_hosts         Generated by ssh-keyscan
    cmds:
      - 'command -v ssh-agent >/dev/null || ( apk add --update openssh-client )'
      - eval $(ssh-agent -s)
      - echo "{{.ssh_private_key}}" | tr -d '\r' | ssh-add -
      - mkdir -p ~/.ssh
      - chmod 700 ~/.ssh
      - echo "{{.ssh_known_hosts}}" >> ~/.ssh/known_hosts
      - chmod 644 ~/.ssh/known_hosts


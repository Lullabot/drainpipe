version: '3'

tasks:
  compile:
    desc: Compiles Sass for custom themes and modules
    summary: |
      Compiles themes/custom/<theme name>/style.scss in custom themes to
      themes/custom/<theme name>/style.css and modules/custom/<module name>/style.scss
      to modules/custom/<module name>/style.css in custom modules.

      Requires sass and esbuild to be installed.

      usage: task sass:compile include_node_modules="modern-normalize another-node-modules-path" themes="my_custom_theme my_other_custom_theme" modules="my_module"
    cmds:
      - if [ "{{.DRAINPIPE_SASS_THEMES}}" == "" ] && [ "{{.DRAINPIPE_SASS_MODULES}}" == "" ]; then echo "No themes or modules provided to compile Sass for"; exit 1; fi
      - |
        THEMES=({{.DRAINPIPE_SASS_THEMES}})
        MODULES=({{.DRAINPIPE_SASS_MODULES}})
        THEMES_COMPILE=""
        MODULES_COMPILE=""
        if [ "{{.DRAINPIPE_SASS_INCLUDE_NODE_MODULES}}" != "" ]; then
          INCLUDES="{{range split " " .DRAINPIPE_SASS_INCLUDE_NODE_MODULES}} -I $(yarn node -e "const path = require('path'); console.log(path.resolve(require.resolve('{{.}}'), '..', '..'));") {{end}}"
        fi
        for THEME in "${THEMES[@]}"; do
          if [ -f "web/themes/custom/$THEME/style.scss" ]; then
            THEMES_COMPILE="$THEMES_COMPILE web/themes/custom/$THEME/style.scss:web/themes/custom/$THEME/style.css"
          fi
        done
        for MODULE in "${MODULES[@]}"; do
          if [ -f "web/modules/custom/$MODULE/style.scss" ]; then
            MODULES_COMPILE="$MODULES_COMPILE web/modules/custom/$MODULE/style.scss:web/modules/custom/$MODULE/style.css"
          fi
        done

        yarn sass {{.args}} {{.CLI_ARGS}} $INCLUDES $THEMES_COMPILE $MODULES_COMPILE

        for THEME in "${THEMES[@]}"; do
          if [ -f "web/themes/custom/$THEME/style.css" ]; then
            yarn esbuild web/themes/custom/$THEME/style.css --minify --sourcemap --allow-overwrite --outfile=web/themes/custom/$THEME/style.css
          fi
        done
        for MODULE in "${MODULES[@]}"; do
          if [ -f "web/modules/custom/$MODULE/style.css" ]; then
            yarn esbuild web/modules/custom/$MODULE/style.css --minify --sourcemap --allow-overwrite --outfile=web/modules/custom/$MODULE/style.css
          fi
        done
  watch:
    desc: As compile, but continues running and watching for changes
    deps:
      - task: compile
        vars:
          args: "--watch"

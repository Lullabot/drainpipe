version: '3'

tasks:
  compile:
    desc: Compiles Sass for custom themes and modules
    summary: |
      Compiles themes/custom/<theme name>/style.scss in custom themes to
      themes/custom/<theme name>/style.css and modules/custom/<module name>/style.scss
      to modules/custom/<module name>/style.css in custom modules.

      Requires sass and esbuild to be installed.

      usage: task sass:compile include_node_modules="modern-normalize another-node-modules-path" themes="my_custom_theme my_other_custom_theme" modules="my_module"
    vars:
      args: ""
    cmds:
      - if ["{{.themes}}" == ""]; echo "No theme names provided"; exit 1; fi
      - yarn sass {{.args}} {{.CLI_ARGS}}{{range split " " .include_node_modules}} -I $(yarn node -e "const path = require('path'); console.log(path.resolve(require.resolve('{{.}}'), '..', '..'));") {{end}}{{range split " " .themes }}web/themes/custom/{{.}}/style.scss:web/themes/custom/{{.}}/style.css {{end}}{{range split " " .modules }}web/modules/custom/{{.}}/style.scss:web/modules/custom/{{.}}/style.css {{end}}
      - |
        themes=({{.themes}})
        for THEME in "${themes[@]}"; do
          yarn esbuild web/themes/custom/$THEME/style.css --minify --sourcemap --allow-overwrite --outfile=web/themes/custom/$THEME/style.css
        done
      - |
        modules=({{.modules}})
        for MODULE in "${modules[@]}"; do
          yarn esbuild web/modules/custom/$MODULE/style.css --minify --sourcemap --allow-overwrite --outfile=web/modules/custom/$MODULE/style.css
        done
  watch:
    desc: The same as compile, but continues running and watching for changes
    cmds:
      - task: compile
        vars: {args: "--watch"}

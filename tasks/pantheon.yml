version: '3'

tasks:
  auth:
    desc: "Authenticates with Pantheon"
    silent: true
    cmds:
      - if [ -z "$PANTHEON_TOKEN" ]; then echo "❌ PANTHEON_TOKEN is not set. Add it to ~/.ddev/global_config.yaml (web-environment) or your project .env file."; exit 1; fi
      - echo "⚡ Authorizing with Pantheon..."
      - terminus auth:login --machine-token="$PANTHEON_TOKEN" >/dev/null 2>&1 || { echo "❌ Authentication failed. Check PANTHEON_TOKEN in ~/.ddev/global_config.yaml or your project .env file."; exit 1; }
      - echo "✅ Authentication successful."

  fetch-db:
    desc: "Fetches a database from Pantheon"
    silent: true
    env:
      DB_DIR: '{{default "/var/www/html/files/db" .DB_DIR}}'
      ENVIRONMENT: '{{default "live" .ENVIRONMENT}}'
    cmds:
      - if [ -z "$PANTHEON_SITE_ID" ]; then echo "❌ PANTHEON_SITE_ID is not set. Please add it to your .env file."; exit 1; fi
      - rm -f $DB_DIR/db.sql.gz $DB_DIR/db.sql
      - task: auth
      - echo "⚡ Fetching database from Pantheon..."
      - |
        TMPFILE=$(mktemp)
        terminus backup:get "${PANTHEON_SITE_ID}.${ENVIRONMENT}" --element=db --to=$DB_DIR/db.sql.gz 2>"$TMPFILE" || {
          echo "❌ Database fetch failed."
          echo "Details: $(cat "$TMPFILE")"
          rm -f "$TMPFILE"
          exit 1
        }
        rm -f "$TMPFILE"
      - echo "✅ Database fetch complete."

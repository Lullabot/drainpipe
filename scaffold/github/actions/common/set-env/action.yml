name: 'Set Env'
description: 'Creates some useful environment variables'
inputs:
  github-api-token:
    description: "GitHub API token"
    required: true
  github-api-token-username:
    description: "GitHub API token username"
    required: true
runs:
  using: "composite"
  steps:
    - run: |
        echo "Setting Drainpipe environment variables:"
        echo "DRAINPIPE_PR_NUMBER=$(echo $GITHUB_REF | awk 'BEGIN { FS = "/" } ; { print $3 }')" >> $GITHUB_ENV
        echo "DRAINPIPE_SHA=$(cat $GITHUB_EVENT_PATH | jq -r .pull_request.head.sha)" >> $GITHUB_ENV

        echo "Debug :bug:"
        echo "GITHUB_REF: $GITHUB_REF"
        echo "GITHUB_EVENT_PATH: $GITHUB_EVENT_PATH"

        echo "DRAINPIPE_SHA: $DRAINPIPE_SHA"
        if [ -z "$DRAINPIPE_SHA" ] || [ "$DRAINPIPE_SHA" = "null" ]; then
          echo "Rewriting DRAINPIPE_SHA to PR number because SHA is null - debug2"
          DRAINPIPE_SHA=$DRAINPIPE_PR_NUMBER
          echo "Drainpipe SHA: $DRAINPIPE_SHA"
          echo "Drainpipe PR Number: $DRAINPIPE_PR_NUMBER"
          echo "DRAINPIPE_SHA=$DRAINPIPE_PR_NUMBER" >> $GITHUB_ENV
        fi

      shell: bash

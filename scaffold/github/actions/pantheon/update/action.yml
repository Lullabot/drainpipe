name: "Update or Install Pantheon Site"
description: "Runs the Drupal updater or the site installer in a Pantheon environment"
inputs:
  site-name:
    description: "Pantheon site machine name"
    required: true
  run-installer:
    description: "Whether or not to run the Drupal site installer. Defaults to false."
    required: false
  environment:
    description: "The environment to run the updates or install in e.g. 'test'"
    required: true
runs:
  using: "composite"
  steps:
    - name: Update site on Pantheon
      run: |
        # Wait for Pantheon to sync.
        source .github/actions/drainpipe/set-env/bash_aliases
        drainpipe_exec "terminus workflow:wait ${SITE_NAME}.${ENVIRONMENT}""
        drainpipe_exec "terminus aliases --only ${SITE_NAME} --yes"
        if [ "${RUN_INSTALLER}" == "true" ]; then
          drainpipe_exec "./vendor/bin/drush @${SITE_NAME}.$${ENVIRONMENT}" --yes site:install --existing-config"
        elif drainpipe_exec "./vendor/bin/task -l | grep '* update: '"; then
          drainpipe_exec "./vendor/bin/task update site=@${SITE_NAME}.${ENVIRONMENT}""
        else
          drainpipe_exec "./vendor/bin/task drupal:update site=@${SITE_NAME}.${ENVIRONMENT}"
        fi
      shell: bash
      env:
        ENVIRONMENT: ${{ inputs.environment }}
        SITE_NAME: ${{ inputs.site-name }}
        RUN_INSTALLER: ${{ inputs.run-installer }}

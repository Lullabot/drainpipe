# DO NOT EDIT THIS FILE
# This file is controlled by Drainpipe, run composer install to apply pending
# updates.  You can add values to the php service using .tugboat/config.drainpipe-override.yml.
#
# Example config.drainpipe-override.yml
# php:
#   aliases:
#   urls:
#   screenshot:
#   visualdiff:
# solr:
#   commands:
#   checkout:
#   depends:
#   volumes:
#   environment:
services:
  php:
    http: false
    image: {{ webserver_image }}
    default: true

    depends:
      - {{ database_type }}
{% if memory_cache_type %}
      - {{ memory_cache_type }}
{% endif %}

    commands:
      init: ./.tugboat/steps/1-init.sh
      update: ./.tugboat/steps/2-update.sh
      build: ./.tugboat/steps/3-build.sh
{% if online_command|length > 0 %}
      online: ./.tugboat/steps/4-online.sh
{% endif %}

{% if overrides.php|length > 0 %}
{{ overrides.php|raw }}
{% endif %}

  {{ database_type }}:
    image: tugboatqa/{{ database_type }}:{{ database_version }}
{% if init.mysql %}
    checkout: true
    commands:
      init:
        - sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d $(cat .taskfile) -b /usr/local/bin
        - wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && chmod +x /usr/bin/yq
        - yq -i 'del(."includes")' Taskfile.yml
        - task tugboat:mysql:init
{% endif %}
{% if memory_cache_type %}

  {{ memory_cache_type }}:
    image: tugboatqa/{{ memory_cache_type }}:{{ memory_cache_version }}
{% if init.redis %}
    checkout: true
    commands:
      init:
        - sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d $(cat .taskfile) -b /usr/local/bin
        - wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && chmod +x /usr/bin/yq
        - yq -i 'del(."includes")' Taskfile.yml
        - task tugboat:redis:init
{% endif %}
{% endif %}
{% if search_type %}

  {{ search_type }}:
    image: tugboatqa/{{ search_type }}:{{ search_version }}
{% if search_type == 'solr' and init.solr %}
    checkout: true
    commands:
      init:
        - sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d $(cat .taskfile) -b /usr/local/bin
        - wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && chmod +x /usr/bin/yq
        - yq -i 'del(."includes")' Taskfile.yml
        - task tugboat:solr:init
{% endif %}
{% if search_type == 'solr' and overrides.solr|length > 0 %}
{{ overrides.solr|raw }}
{% endif %}
{% endif %}

# DO NOT EDIT THIS FILE
# This file is controlled by Drainpipe, run composer install to apply pending
# updates.  You can add values to the php and solr services adding a file named
# config.drainpipe-override.yml to the .tugboat folder.
#
# Example config.drainpipe-override.yml
# php:
#   aliases:
#   urls:
#   screenshot:
#   visualdiff:
# solr:
#   commands:
#   checkout:
#   depends:
#   volumes:
#   environment:
#   aliases:
#   urls:
services:
  php:
    http: false
    image: tugboatqa/php-nginx:8.3-fpm-bookworm
    default: true
    depends:
      - mariadb
      - redis
      - elasticsearch
    commands:
      init:
        - |
          apt-get update
          apt-get install -y mariadb-client
          ln -snf "${TUGBOAT_ROOT}/web" "${DOCROOT}"
          docker-php-ext-install opcache
          apt-get install -y libpng-dev libjpeg-dev libfreetype6-dev
          apt-get install -y libwebp-dev libwebp7 webp libmagickwand-dev
          docker-php-ext-configure gd --with-freetype --with-jpeg --with-webp
          docker-php-ext-install gd
          apt-get install -y imagemagick
          yes '' | pecl install -f redis
          echo 'extension=redis.so' > /usr/local/etc/php/conf.d/redis.ini
          #drainpipe-start
          # This is necessary for testing as this repository doesn't hold a Drupal site.
          shopt -s dotglob
          rm -rf /var/www/html/*
          composer create-project drupal/recommended-project /var/www/html
          ln -snf "/var/www/html/web" "${DOCROOT}"
          cd /var/www/html
          composer config extra.drupal-scaffold.gitignore true
          composer config --json extra.drupal-scaffold.allowed-packages \[\"lullabot/drainpipe\"]
          composer config --no-plugins allow-plugins.composer/installers true
          composer config --no-plugins allow-plugins.drupal/core-composer-scaffold true
          composer config --no-plugins allow-plugins.lullabot/drainpipe true
          composer config repositories.drainpipe --json "{\"type\": \"path\", \"url\": \"${TUGBOAT_ROOT}\", \"options\": {\"symlink\": true}}"
          composer config extra.drainpipe --json '{"tugboat": {}}'
          composer config minimum-stability dev
          composer require lullabot/drainpipe --with-all-dependencies
          cp web/sites/default/default.settings.php web/sites/default/settings.php
          #drainpipe-end
          mkdir -p "${DOCROOT}/sites/default/files"
          chmod 777 "${DOCROOT}/sites/default/files"
          chgrp -R www-data "${DOCROOT}/sites/default/files"
          composer install --ignore-platform-reqs
          apt-get install -y ca-certificates gnupg
          mkdir -p /etc/apt/keyrings
          curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
          NODE_MAJOR=$(cat ${TUGBOAT_ROOT}/.nvmrc)
          echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_$NODE_MAJOR.x nodistro main" | sudo tee /etc/apt/sources.list.d/nodesource.list
          echo 'Package: *' > /etc/apt/preferences.d/nodesource-nodejs
          echo 'Pin: origin deb.nodesource.com' >> /etc/apt/preferences.d/nodesource-nodejs
          echo 'Pin-Priority: 1001' >> /etc/apt/preferences.d/nodesource-nodejs
          apt-get update
          apt-get -qq install nodejs
          apt-get clean
          corepack enable
          nodejs -v | grep -q v$NODE_MAJOR
          TASKFILE=$(cat ${TUGBOAT_ROOT}/vendor/lullabot/drainpipe/.taskfile)
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d ${TASKFILE} -b /usr/local/bin
      update:
        - |
          #drainpipe-start
          cd /var/www/html
          composer install
          task sync
          #drainpipe-end
          composer install
          chmod 755 ${DOCROOT}/sites/default
          chgrp -R www-data "${DOCROOT}/sites/default/files"
          find "${DOCROOT}/sites/default/files" -type d -exec chmod 2775 {} \;
          find "${DOCROOT}/sites/default/files" -type f -exec chmod 0664 {} \;
          #drainpipe-start
          ./vendor/bin/drush config:export --yes
          #drainpipe-end
          task update
      build:
        - |
          #drainpipe-start
          cd /var/www/html
          #drainpipe-end
          task build
          task update
          #drainpipe-start
          task tugboat:drush-uli-ready
          #drainpipe-end
      online:
        - task online:tugboat
    aliases:
      - foo
    urls:
      - /
      - '/?v=1'
    screenshot:
      timeout: 45
    visualdiff:
      fullPage: false

  mariadb:
    image: tugboatqa/mariadb:10.11

  redis:
    image: tugboatqa/redis:6-bullseye

  elasticsearch:
    image: tugboatqa/elasticsearch:7.17.14
